## bpmn

eclipse下安装：

Help->Install New Software->Name: Activiti BPMN 2.0 designer,Location: https://activiti.org/designer/update/

## bpmn设计

eclipse下-new->other->activiti diagram

![bpmn](pics/0.jpg)

注意设置每个task的id和bpmn的id；

## 建表

引入springboot，activiti依赖

![depen](pics/1.jpg)

其他数据源依赖等省略

自动建表配置：

		spring:
		  application:
		    name: myapp
		  activiti:
		    database-schema-update: true
		    check-process-definitions: false
		    history-level: full

@SpringBootApplication(exclude = {SecurityAutoConfiguration.class,DataSourceAutoConfiguration.class})


## 示例
	
	//流程服务示例
	public class ProcessService {
	    @Resource
	    private RepositoryService repositoryService;
	    @Resource
	    private RuntimeService runtimeService;
	    @Resource
	    private TaskService taskService;
	    @Resource
	    private HistoryService historyService;
	
	    //部署流程
	    public void deploy(String name) {
	        repositoryService.createDeployment()
	                .name(name)
	                .addClasspathResource("processes/" + name + ".bpmn")
	                .deploy();
	    }
	
	    //删除流程
	    public void unDeploy(String name) {
	        Deployment deployment = repositoryService.createDeploymentQuery()
	                .processDefinitionKey(name)
	                .singleResult();
	        //级联删除
	        repositoryService.deleteDeployment(deployment.getId(), true);
	
	    }
	
	    //启动流程
	    public ProcessInstance startProcess(String processKey, Map map) {
	        return runtimeService.startProcessInstanceByKey(processKey, map);
	    }
	
	    public void deleteProcessById(String id) {
	        runtimeService.deleteProcessInstance(id, "用户撤销");
	    }
	
	    /**
	     * 根据处理人和流程部署id获取需要审批的流程
	     *
	     * @param userName      处理人
	     * @param definitionKey 流程部署id
	     * @return
	     */
	    public List<Task> getMyTask(String userName, String definitionKey) {
	        return taskService.createTaskQuery().processDefinitionKey(definitionKey).taskCandidateOrAssigned(userName).list();
	    }
	
	    public List<String> getHisProcess(String userName, List<String> stringList) {
	        List<HistoricTaskInstance> taskInstanceList = historyService.createHistoricTaskInstanceQuery().processDefinitionKeyIn(stringList).taskAssignee(userName).list();
	        List list = new ArrayList();
	        for (HistoricTaskInstance taskInstance : taskInstanceList) {
	            String instanceId = taskInstance.getProcessInstanceId();
	            list.add(instanceId);
	        }
	        LinkedHashSet linkedHashSet = new LinkedHashSet<>(list);
	        List newList = new ArrayList(linkedHashSet);
	        return newList;
	    }
	
	    //处理流程(单实例流程)
	    public String completeTask(String processId, Map map) {
	        Task task = taskService.createTaskQuery().processInstanceId(processId).singleResult();
	
	        taskService.complete(task.getId(), map);
	        return task.getTaskDefinitionKey();
	    }
	
	    /**
	     * 根据流程实例获取任务节点名称(单实例流程)
	     *
	     * @param processId
	     * @return
	     */
	    public String getTaskDefinitionKey(String processId) {
	        Task task = taskService.createTaskQuery().processInstanceId(processId).singleResult();
	        return task.getTaskDefinitionKey();
	    }
	
	    //添加备注信息
	    public void addComment(String processId, String comments, String eName) {
	        //添加备注的审核人
	        Authentication.setAuthenticatedUserId(eName);
	        Task task = taskService.createTaskQuery().processInstanceId(processId).taskAssignee(eName).singleResult();
	        taskService.addComment(task.getId(), processId, comments);
	
	    }
	
	    //获取流程相关信息
	    public List<HistoricTaskInstance> getHisTask(String instanceId) {
	        List<HistoricTaskInstance> list = historyService.createHistoricTaskInstanceQuery().processInstanceId(instanceId).orderByHistoricTaskInstanceStartTime().desc().list();
	//        List<HistoricTaskInstance> newList = new ArrayList<>();
	//        for (int i = list.size() - 1; i >= 0; i--) {
	//            newList.add(list.get(i));
	//        }
	        return list;
	    }
	
	    /**
	     * 获取流程变量对象信息(包含一个变量设置多次不同的值的情况，即打回后重新审批)
	     *
	     * @param instanceId   流程实例id
	     * @param variableName 变量名称
	     * @param taskId       任务id
	     * @return
	     */
	    public HistoricVariableUpdate getProcessVarible(String instanceId, String variableName, String taskId) {
	        //此方法获取的变量值会被最新的变量值覆盖（当一个节点走过多次时，变量值为最后一次设置的值）
	//        HistoricVariableInstance historicVariableInstance = historyService.createHistoricVariableInstanceQuery().processInstanceId(instanceId).variableName(variableName).singleResult();
	        //根据流程实例id获取act_hi_actinst列表
	        List<HistoricActivityInstance> activityInstanceList = historyService.createHistoricActivityInstanceQuery().processInstanceId(instanceId).list();
	        for (HistoricActivityInstance activityInstance : activityInstanceList) {
	            if ("".equals(activityInstance.getTaskId()) || activityInstance.getTaskId() == null) {
	                continue;
	            }
	            String instanceTaskId = activityInstance.getTaskId();
	            //根据taskId取出act_hi_actinst对象
	            if (taskId.equals(instanceTaskId)) {
	//              //根据act_hi_actinst中的id和instanceId获取act_hi_detail列表（此时HistoricDetail还没有包含变量信息）
	                List<HistoricDetail> list = historyService.createHistoricDetailQuery().variableUpdates().activityInstanceId(activityInstance.getId()).processInstanceId(instanceId).list();
	                for (HistoricDetail historicDetail : list) {
	                    //将HistoricDetail转换为HistoricVariableUpdate才可以获取到variables
	                    HistoricVariableUpdate variableUpdate = (HistoricVariableUpdate) historicDetail;
	                    //获取传递过来的变量名称的值
	                    if (variableName.equals(variableUpdate.getVariableName())) {
	//                        System.out.println(variableUpdate.getVariableName()+"---"+variableUpdate.getValue());
	                        return variableUpdate;
	                    }
	                }
	            }
	        }
	
	        return null;
	    }
	
	    /**
	     * 获取审批信息
	     *
	     * @param taskId
	     * @return
	     */
	    public List<Comment> getComments(String taskId) {
	        List<Comment> list = taskService.getTaskComments(taskId);
	        return list;
	    }
	
	    /**
	     * 获取上一节点信息
	     *
	     * @param list
	     * @return
	     */
	    public Map<String, HistoricActivityInstance> getLastNodeList(List<String> list) {
	        Map<String, HistoricActivityInstance> instanceMap = list.stream().collect(Collectors.toMap(var -> var, h -> {
	            List<HistoricActivityInstance> userTask = historyService.createHistoricActivityInstanceQuery().activityType("userTask")
	                    .processInstanceId(h).finished().orderByHistoricActivityInstanceEndTime()
	                    .desc().list();
	            return userTask.get(0);
	        }));
	        return instanceMap;
	    }
	
	    public Task getCurrentTaskByProcessId(String processId){
	        return taskService.createTaskQuery().processInstanceId(processId).singleResult();
	    }
	
	}


## activiti接口设计

顶层是ProcessEngine，他管理以下接口

![engine](pics/2.jpg)

RepositoryService : 部署相关的业务，和re相关的表

RuntimeService : 运行时相关的业务，和ru相关的表

HistoryService : 历史相关的表，hi相关的

TaskService : 管理任务相关的，管理hi_task和ru_task


## 实战

#### 部署流程

    /**
     * 部署bpmn
     */
    public void deploy() {
    	RepositoryService service = engine.getRepositoryService();
    	Deployment deploy = service.createDeployment()
        .name("申请api")
        .addClasspathResource("processes/" + "request_for_api" + ".bpmn")
        //.addClasspathResource("processes/" + "request_for_api" + ".jpg")//需要的话可以添加jpg
        .deploy();
    	System.out.println(deploy.getId());
    	System.out.println(deploy.getName());
    }
	545001
	申请api


#### 启动流程

    /**
     * 启动流程
     */
    @Test
    public void start() {
    	RuntimeService service = engine.getRuntimeService();
    	HashMap<String,Object> hashMap = new HashMap();
    	hashMap.put("aaa", "bbb");
    	hashMap.put("request", "张三");
    	ProcessInstance instance = service.startProcessInstanceByKey("openapisubscribe",hashMap);
    	System.out.println(instance.getId());//流程实例id
    	System.out.println(instance.getProcessDefinitionId());//流程定义id
    	System.out.println(instance.getActivityId());//当前活动的id
    	System.out.println(instance.getProcessInstanceId());
    	System.out.println(instance.getProcessVariables());
    }
	547501
	openapisubscribe:1:545004
	null
	547501
	{}

#### 根据流程定义id和任务归属人查询流程


    /**
     * 查询流程
     */
    @Test
    public void query0() {
    	TaskService taskService = engine.getTaskService();
    	List<Task> list = taskService.createTaskQuery()
    	.processDefinitionKey("openapisubscribe")
    	.taskAssignee("张三").list();
    	
    	for (Task task : list) {
			System.out.println(task.getProcessInstanceId());//流程实例id
			System.out.println(task.getId());//任务id
			System.out.println(task.getAssignee());//任务负责人
			System.out.println(task.getName());//任务名
		}
    }
	547501
	547509
	张三
	提交申请

#### 完成某个task，一般来说先查询在完成

    /**
     * 完成流程
     */
    @Test
    public void complete() {
    	TaskService taskService = engine.getTaskService();
    	HashMap<String,Object> hashMap = new HashMap();
    	hashMap.put("aaa", "bbb");
    	hashMap.put("admin", "李四");
    	taskService.complete("552509", hashMap);
    }

#### 历史

    /**
     * 历史
     */
    @Test
    public void his() {
    	HistoryService service = engine.getHistoryService();
    	HistoricTaskInstanceQuery query = service.createHistoricTaskInstanceQuery();
    	HistoricTaskInstanceQuery taskInstanceQuery = query.processDefinitionKey("openapisubscribe");
    	List<HistoricTaskInstance> list = taskInstanceQuery.orderByHistoricTaskInstanceStartTime().asc().list();
    	for (HistoricTaskInstance task : list) {
    		System.out.println(task.getProcessInstanceId());//流程实例id
			System.out.println(task.getId());//任务id
			System.out.println(task.getAssignee());//任务负责人
			System.out.println(task.getName());//任务名
			System.out.println(task.getProcessVariables());//流程变量
			System.out.println(task.getTaskLocalVariables());//任务名
		}
    }



## 个人任务分配

### 表达式分配

1. 使用UEL表达式分配，如：

    ![uel](pics/3.jpg)
    ![uel-java](pics/4.jpg)

2. 使用UEL-method
  
    ![uel-method](pics/5.jpg)

3. UEL-混合

    ![uel-混合](pics/6.jpg)

### 监听器分配

在bpmn中不需要assign了


通过设置listener;有4种listener,通过实现**org.activiti.engine.delegate.TaskListener**来完成功能

1. create
2. assignment
3. complete
4. all


## 流程变量

流程变量中如果需要存pojo需要实现序列化接口

流程变量的作用域可以为流程实例(默认),task,excution;

我们可以在属性和连线上使用uel表达式来使用流程变量

启动时设置流程变量:

		HashMap<String,Object> hashMap = new HashMap();
    	hashMap.put("aaa", "bbb");
    	hashMap.put("request", "张三");
    	ProcessInstance instance = service.startProcessInstanceByKey("openapisubscribe","张三出差的业务key",hashMap);

通过流程实例设置:

		RuntimeService service = engine.getRuntimeService();
    	HashMap<String,Object> hashMap = new HashMap();
    	hashMap.put("aaa", "bbb");
    	hashMap.put("request", "张三");
    	ProcessInstance instance = service.startProcessInstanceByKey("openapisubscribe","张三出差的业务key");  	
    	service.setVariables(instance.getId(), hashMap);

通过任务设置:

		taskService.setVariables(taskId, hashMap);


## 组任务

candidate users

在流程中节点设置多个候选人,候选人之间用逗号分开;

组任务需要拾取,拾取后就成了个人任务,拾取后不想办理可以归还给组,变为组任务;

查询组任务:

	Task task = taskService.createTaskQuery().taskCandidateUser(user).list().get(0);

拾取:

	taskService.claim(taskId,user)

归还,在拾取后任务的Assign变为了我们设置的user,现在只要把他设置为null

	taskService.setAssign(tasakId,null)

交接任务:

	taskService.setAssign(tasakId,candidateUser)







